<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		
		<link rel="stylesheet" type="text/css" href="css/reset.css"/>
		<link rel="stylesheet" type="text/css" href="css/public.css"/>
		<link rel="stylesheet" type="text/css" href="css/shopCar.css">
		<link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_733336_hhi82gi084s.css"/>
	</head>
	<body>
		<div class="header_bg">
			<div class="header">
				<a href="index.html"><img src="img/loginlogo.jpg" alt=""></a>
				<div class="header_r">
					<span>您好，欢迎光临1号店！ </span>
					<a href="login.html" id="login">请登录</a>
					<em>帮助中心</em>
				</div>
			</div>
		</div>

		<div class="section_bg">
			<!-- <div class="section">
					<div class="section_l">
						<img src="img/offline.gif" alt="">
					</div>
					<div class="section_r">
						<p>购物车还是空的呢，快去采购吧~
							<br/>
							或者登录查看之前加入的商品。
						</p>
						<div class="btn_box">
							<a href="login.html">登录</a>
							<a href="index.html">去逛逛</a>
						</div>
					</div>
				</div> -->
			<table class="table">
				<thead>
					<tr>
						<th>商品名称</th>
						<th>单价(元)</th>
						<th>购买数量</th>
						<th>小计(元)</th>
						<th>操作</th>
					</tr>
					
				</thead>
				<tbody class="tbox">
					
				</tbody>
			</table>
			<div class="pays">
				<div class="pays_main">
					<span>合计<b></b>元</span>
					<a href="">去结算</a>
				</div>
			</div>
		</div>
		
		<div id="foot"></div>
	</body>
</html>
<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript">
	$("#foot").load('index.html .footer_bg');
</script>

<script>
	var shopCar = (function(){
		$login = $('#login');
		$tbox = $('.tbox');
		var shopList = localStorage.shopList || '[]';
   		shopList = JSON.parse(shopList);
		return {
			init(){
				this.events();
				this.getData();
				this.showMod(shopList);
			},
//			展示数据,商品跳转时将信息加载到localStorage
//			现在从localStorage中获取信息
			showMod(data){
				var str = []
	            for(var i = 0; i < data.length; i++) {
	                var li = `<tr id="${data.id}">
	                            <td>${data[i].name}</td>
	                            <td>${data[i].price}</td>
	                            <td><input type='number' value='${data[i].count}' />
	                            
	                            </td>
	                            <td>${data[i].price*data[i].count}</td>
	                            <td><button class='btn btn-danger del-btn'>删除</button></td>
	                            </tr>`;
	                str.push(li);
	            }
	            $tbox.html(str.join(''));
			},
	        //  事件函数
	        events() {
	            var _this = this;
	            $tbox.on('change', 'input', function() {
	                // 获取此tr
	                var tr = $(this).closest('tr');
	                // 获取文本值(商品更新后的数据)
	                var val = $(this).val();
	                // 修改对应数据
	                shopList[tr.index()].count = val;
	                // 存入本地数据库
	                localStorage.shopList = JSON.stringify(shopList);
	                _this.showMod(JSON.parse(localStorage.shopList));
	            })
	            $tbox.on('click', '.del-btn', function() {
	               var tr = $(this).closest('tr');
	               // 删除数组中对应的数据
	               shopList.splice(tr.index(), 1);
	               // 存入到本地数据库
	               localStorage.shopList = JSON.stringify(shopList);
	               // 移出dom元素
	               tr.remove()
	            })
	        },
			getData() {
	            var _this = this;
	            $.post('php/get_date.php',_this.cbGetData, "json");
	        },
	        cbGetData(json){
//				进行判断,如果与后台信息匹配就执行
                if(json.code == 200) {
//	                	把用户名赋给a
                	$login.html(json.data[0][1]);
//	                	改变a跳转的界面
                	$login.attr('href','person.html');

//	                	浏览器加载完成后 执行刷新一次
            	    window.onload = function(){
					var url=document.location.href;  //获取浏览器访问栏里的地址
					    if( url.indexOf("r=")==-1 ){    //判断地址后面是否多了某些值，没有就进方法里进行刷新
							var t = new Date();
			            	window.location.href = "<%=request.getContextPath()%>/url?r="+t.getTime();     
				        }
				    } 
	            }
	        }
		}
	})();
	shopCar.init();
</script>
